# 预排期批量选择交互优化

## 📝 优化内容

完全参照需求池的序号/复选框交互逻辑，实现更直观的批量选择体验。

---

## 🎯 核心改进

### 1. 表头序号列留空 ✅
**调整前**:
- 显示复选框，用于全选所有版本的需求

**调整后**:
- 留空，不显示任何文字或控件
- 更简洁，避免混淆

### 2. 版本标题行添加复选框 ✅
**调整前**:
- 版本标题占据整行
- 无法快速全选该版本的需求

**调整后**:
```
┌──────┬─────────────────────────────┐
│  ☑   │ ▼ v1.0.0 • 10个需求         │
└──────┴─────────────────────────────┘
```
- 第一列：复选框（用于选择该版本所有需求）
- 剩余列：版本信息（折叠按钮 + 版本号 + 需求数量）

### 3. 批量选择模式 ✅
**交互逻辑**（参照需求池）:

#### 默认状态：显示序号
```
┌──────┬──────┬──────────┐
│      │  ID  │  标题    │
├──────┼──────┼──────────┤
│  ☑   │ v1.0.0 • 5个需求 │
├──────┼──────┼──────────┤
│  1   │ #001 │ 需求A    │
│  2   │ #002 │ 需求B    │
│  3   │ #003 │ 需求C    │
└──────┴──────┴──────────┘
```
- 序号列显示行号（1, 2, 3...）
- 版本复选框未勾选

#### 批量模式：显示复选框
```
┌──────┬──────┬──────────┐
│      │  ID  │  标题    │
├──────┼──────┼──────────┤
│  ☑   │ v1.0.0 • 5个需求 │  ← 勾选版本复选框
├──────┼──────┼──────────┤
│  ☑   │ #001 │ 需求A    │  ← 序号变成复选框
│  ☑   │ #002 │ 需求B    │  ← 默认全选
│  ☑   │ #003 │ 需求C    │  ← 可单独取消
└──────┴──────┴──────────┘
```
- 勾选版本复选框后，序号列自动变成复选框
- 该版本所有需求默认被选中
- 可以单独勾选/取消某个需求

---

## 🔧 技术实现

### 文件修改

#### 1. ScheduledMainTable.tsx

**表头序号列**
```tsx
// 调整前
<TableHead className="...">
  <div className="flex items-center justify-center">
    <input type="checkbox" ... />
  </div>
</TableHead>

// 调整后 ✅
<TableHead className="...">
  {/* 序号列 - 留空，不显示文字 */}
</TableHead>
```

#### 2. ScheduledVersionGroup.tsx

**添加批量模式状态**
```tsx
// 批量选择模式状态
const [batchMode, setBatchMode] = useState(false);

// 处理版本级别的全选复选框
const handleVersionCheckbox = (checked: boolean) => {
  setBatchMode(checked);      // 切换批量模式
  onSelectAll(checked);        // 全选/取消全选该版本
};
```

**版本标题行结构**
```tsx
<TableRow className="bg-muted/50 hover:bg-muted/70 border-t-2">
  {/* 第一列：复选框 */}
  <td className="w-[80px] px-2 py-3 text-center border-r">
    <input
      type="checkbox"
      checked={isAllSelected}
      ref={(el) => {
        if (el) el.indeterminate = isIndeterminate;
      }}
      onChange={(e) => {
        e.stopPropagation();
        handleVersionCheckbox(e.target.checked);
      }}
      onClick={(e) => e.stopPropagation()}
      title={isAllSelected ? '取消选择该版本' : '选择该版本所有需求'}
    />
  </td>
  
  {/* 剩余列：版本信息 */}
  <td colSpan={10} className="p-0">
    <div onClick={onToggleExpanded}>
      {/* 折叠按钮 + 版本号 + 需求数量 */}
    </div>
  </td>
</TableRow>
```

**数据行序号/复选框切换**
```tsx
<IndexCell
  index={index}
  isSelectable={batchMode}  // ← 关键：根据batchMode切换
  isSelected={selectedRequirements.includes(requirement.id)}
  onSelect={(checked) => onSelectRequirement(requirement.id, checked)}
/>
```

---

## 📊 交互流程

### 流程图

```
用户点击版本复选框
        ↓
  checked = true?
   ↙           ↘
 是             否
  ↓             ↓
进入批量模式    退出批量模式
  ↓             ↓
序号→复选框     复选框→序号
  ↓             ↓
全选该版本      取消所有选择
```

### 状态变化

```
初始状态:
- batchMode = false
- selectedCount = 0
- 序号列显示: 1, 2, 3...

点击版本复选框（勾选）:
- batchMode = true ✓
- selectedCount = requirements.length ✓
- 序号列显示: ☑, ☑, ☑... ✓

点击版本复选框（取消）:
- batchMode = false ✓
- selectedCount = 0 ✓
- 序号列显示: 1, 2, 3... ✓

批量模式下点击单个复选框:
- batchMode = true（保持）
- selectedCount 增加或减少
- 版本复选框显示半选状态（indeterminate）
```

---

## 🎨 视觉效果

### 版本复选框状态

#### 未选中
```
┌──────┐
│  ☐   │  v1.0.0 • 10个需求
└──────┘
```

#### 全选
```
┌──────┐
│  ☑   │  v1.0.0 • 10个需求  [已选择 10]
└──────┘
```

#### 部分选中（半选）
```
┌──────┐
│  ☑̸   │  v1.0.0 • 10个需求  [已选择 3]
└──────┘
```

### 序号列切换动画

```
默认状态        →        批量模式
┌──────┐              ┌──────┐
│  1   │              │  ☑   │
│  2   │    勾选版本   │  ☑   │
│  3   │    ────→     │  ☑   │
│  4   │              │  ☑   │
│  5   │              │  ☑   │
└──────┘              └──────┘
```

---

## 🎯 用户体验提升

### 1. 更直观的批量选择 ⭐⭐⭐⭐⭐
**前**: 需要手动点击每个需求的复选框
**后**: 点击版本复选框即可全选该版本，进入批量模式

### 2. 清晰的模式切换 ⭐⭐⭐⭐⭐
**前**: 序号和复选框混用，容易混淆
**后**: 
- 默认模式：显示序号，适合浏览
- 批量模式：显示复选框，适合批量操作

### 3. 统一的交互逻辑 ⭐⭐⭐⭐⭐
**前**: 预排期页面和需求池页面交互不一致
**后**: 完全一致的序号/复选框切换逻辑

### 4. 智能的默认行为 ⭐⭐⭐⭐
**前**: 进入批量模式后需要手动全选
**后**: 勾选版本复选框自动全选该版本，节省操作步骤

---

## 📋 使用场景

### 场景1：快速批量分配版本
```
1. 勾选 v1.0.0 的版本复选框
   → 自动全选该版本10个需求
2. 点击批量操作栏的"批量分配版本"
3. 选择目标版本 v1.1.0
   → 10个需求全部移动到 v1.1.0
```

### 场景2：部分需求批量评审
```
1. 勾选 v1.0.0 的版本复选框
   → 自动全选该版本10个需求
2. 取消勾选不需要评审的3个需求
   → 剩余7个需求被选中
3. 点击批量操作栏的"批量评审"
   → 7个需求批量设置为"一级评审通过"
```

### 场景3：快速查看某版本需求
```
1. 不勾选版本复选框
   → 保持序号显示模式
2. 点击版本标题折叠/展开
   → 浏览该版本的需求
```

---

## 🧪 测试要点

### 功能测试
- [ ] 表头序号列是否留空
- [ ] 版本标题行是否显示复选框
- [ ] 勾选版本复选框是否进入批量模式
- [ ] 批量模式下序号列是否变成复选框
- [ ] 勾选版本复选框是否自动全选该版本
- [ ] 取消版本复选框是否退出批量模式并取消所有选择
- [ ] 批量模式下单独勾选/取消需求是否正常
- [ ] 版本复选框的半选状态是否正确显示
- [ ] 折叠/展开功能是否不受影响

### 交互测试
- [ ] 点击版本复选框是否不会触发折叠/展开
- [ ] 点击版本标题区域是否正常折叠/展开
- [ ] 批量操作栏是否正确显示选中数量
- [ ] 批量操作是否只作用于选中的需求

### 视觉测试
- [ ] 版本复选框与序号列复选框是否对齐
- [ ] 版本标题行的布局是否合理
- [ ] 复选框的hover效果是否正常
- [ ] 半选状态的图标是否清晰可见

---

## 💡 技术亮点

### 1. 事件冒泡控制
```tsx
onClick={(e) => e.stopPropagation()}
```
防止点击复选框时触发版本折叠/展开

### 2. 半选状态显示
```tsx
ref={(el) => {
  if (el) el.indeterminate = isIndeterminate;
}}
```
使用DOM的indeterminate属性显示半选状态

### 3. 批量模式状态管理
```tsx
const [batchMode, setBatchMode] = useState(false);
```
每个版本独立管理批量模式，互不影响

### 4. 条件渲染
```tsx
<IndexCell
  index={index}
  isSelectable={batchMode}  // 根据模式切换显示
  ...
/>
```
利用IndexCell组件的isSelectable属性实现无缝切换

---

## 🔄 与需求池的一致性

| 特性 | 需求池 | 预排期（调整后） | 一致性 |
|------|--------|-----------------|--------|
| 表头复选框 | ✅ 有（全选所有） | ❌ 留空 | ⚠️ 略有不同* |
| 序号/复选框切换 | ✅ 支持 | ✅ 支持 | ✅ 完全一致 |
| 批量模式触发 | 点击表头复选框 | 点击版本复选框 | ✅ 逻辑一致 |
| 默认全选行为 | ✅ 全选所有 | ✅ 全选该版本 | ✅ 完全一致 |
| 半选状态 | ✅ 支持 | ✅ 支持 | ✅ 完全一致 |

*注：预排期因为有版本分组，表头复选框移到版本级别更合理

---

## 🎉 总结

本次优化完全参照需求池的交互逻辑，实现了：

✅ **表头序号列留空** - 更简洁  
✅ **版本复选框** - 快速全选该版本  
✅ **批量模式切换** - 序号 ↔ 复选框  
✅ **智能默认行为** - 勾选即全选  
✅ **半选状态** - 清晰的视觉反馈  
✅ **统一交互** - 与需求池一致  

**用户体验显著提升！批量操作更加直观高效！** 🚀

---

## 🔗 相关文档

- [表格优化文档](./SCHEDULED_TABLE_OPTIMIZATION.md) - 固定表头优化
- [样式调整文档](./SCHEDULED_TABLE_STYLE_UPDATE.md) - 表头样式统一
- [重构最终总结](./REFACTOR_FINAL_SUMMARY.md) - 整体重构总结

---

**现在请刷新浏览器体验新的批量选择交互！** 🎊

