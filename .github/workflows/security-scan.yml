name: Security Scan

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  schedule:
    # æ¯å¤©å‡Œæ™¨2ç‚¹è¿è¡Œå®‰å…¨æ‰«æ
    - cron: '0 2 * * *'

jobs:
  security-scan:
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        node-version: [18, 20]
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # è·å–å®Œæ•´å†å²è®°å½•ç”¨äºå®‰å…¨æ‰«æ
    
    - name: Setup Node.js ${{ matrix.node-version }}
      uses: actions/setup-node@v4
      with:
        node-version: ${{ matrix.node-version }}
        cache: 'npm'
    
    - name: Install dependencies
      run: npm ci
    
    # 1. ä¾èµ–æ¼æ´æ‰«æ
    - name: Run npm audit
      run: |
        npm audit --audit-level=moderate --json > audit-results.json || true
        npm audit --audit-level=moderate
    
    - name: Upload audit results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: audit-results-node-${{ matrix.node-version }}
        path: audit-results.json
    
    # 2. ä»£ç å®‰å…¨æ‰«æ
    - name: Run ESLint security rules
      run: |
        npx eslint . --ext .js,.jsx,.ts,.tsx --config .eslintrc.security.js --format json --output-file eslint-security-results.json || true
    
    - name: Upload ESLint security results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: eslint-security-results-node-${{ matrix.node-version }}
        path: eslint-security-results.json
    
    # 3. ä¾èµ–è®¸å¯è¯æ£€æŸ¥
    - name: Check licenses
      run: |
        npx license-checker --json --out licenses.json || true
    
    - name: Upload license results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: license-results-node-${{ matrix.node-version }}
        path: licenses.json
    
    # 4. æ•æ„Ÿä¿¡æ¯æ‰«æ
    - name: Run TruffleHog (secrets scanner)
      uses: trufflesecurity/trufflehog@main
      with:
        path: ./
        base: main
        head: HEAD
        extra_args: --debug --only-verified
    
    # 5. å®¹å™¨å®‰å…¨æ‰«æï¼ˆå¦‚æœæœ‰ Dockerfileï¼‰
    - name: Run Trivy vulnerability scanner
      uses: aquasecurity/trivy-action@master
      if: hashFiles('**/Dockerfile') != ''
      with:
        scan-type: 'fs'
        scan-ref: '.'
        format: 'sarif'
        output: 'trivy-results.sarif'
    
    - name: Upload Trivy scan results
      uses: github/codeql-action/upload-sarif@v3
      if: always() && hashFiles('**/Dockerfile') != ''
      with:
        sarif_file: 'trivy-results.sarif'
    
    # 6. ä»£ç è´¨é‡å®‰å…¨æ£€æŸ¥
    - name: Run SonarCloud Scan
      if: github.event_name == 'pull_request'
      uses: SonarSource/sonarcloud-github-action@master
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
    
    # 7. å®‰å…¨æµ‹è¯•æŠ¥å‘Š
    - name: Generate security report
      if: always()
      run: |
        echo "# Security Scan Report" > security-report.md
        echo "## Dependencies Audit" >> security-report.md
        if [ -f audit-results.json ]; then
          echo "âœ… npm audit completed" >> security-report.md
        else
          echo "âŒ npm audit failed" >> security-report.md
        fi
        
        echo "## Code Security" >> security-report.md
        if [ -f eslint-security-results.json ]; then
          echo "âœ… ESLint security scan completed" >> security-report.md
        else
          echo "âŒ ESLint security scan failed" >> security-report.md
        fi
        
        echo "## License Check" >> security-report.md
        if [ -f licenses.json ]; then
          echo "âœ… License check completed" >> security-report.md
        else
          echo "âŒ License check failed" >> security-report.md
        fi
        
        echo "## Secrets Scan" >> security-report.md
        echo "âœ… TruffleHog secrets scan completed" >> security-report.md
        
        if [ -f trivy-results.sarif ]; then
          echo "## Container Security" >> security-report.md
          echo "âœ… Trivy container scan completed" >> security-report.md
        fi
    
    - name: Upload security report
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: security-report
        path: security-report.md

  # é«˜çº§å®‰å…¨æ‰«æï¼ˆä»…å¯¹ main åˆ†æ”¯ï¼‰
  advanced-security:
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
    
    - name: Install dependencies
      run: npm ci
    
    # 1. ä»£ç å¤æ‚åº¦åˆ†æ
    - name: Run complexity analysis
      run: |
        npx eslint . --ext .js,.jsx,.ts,.tsx --config .eslintrc.complexity.js --format json --output-file complexity-results.json || true
    
    # 2. ä¾èµ–å…³ç³»åˆ†æ
    - name: Analyze dependencies
      run: |
        npx madge --circular --json src/ > circular-deps.json || true
        npx madge --summary src/ > deps-summary.txt || true
    
    # 3. å®‰å…¨é…ç½®æ£€æŸ¥
    - name: Check security configurations
      run: |
        echo "Checking security configurations..."
        
        # æ£€æŸ¥ package.json å®‰å…¨é…ç½®
        if [ -f package.json ]; then
          echo "âœ… package.json exists"
          # æ£€æŸ¥æ˜¯å¦æœ‰å®‰å…¨ç›¸å…³çš„è„šæœ¬
          if grep -q "audit" package.json; then
            echo "âœ… npm audit script found"
          else
            echo "âš ï¸ npm audit script not found"
          fi
        fi
        
        # æ£€æŸ¥ç¯å¢ƒå˜é‡æ–‡ä»¶
        if [ -f .env.example ]; then
          echo "âœ… .env.example exists"
        else
          echo "âŒ .env.example missing"
        fi
        
        # æ£€æŸ¥å®‰å…¨å¤´é…ç½®
        if [ -f next.config.ts ]; then
          echo "âœ… Next.js config exists"
        else
          echo "âŒ Next.js config missing"
        fi
    
    # 4. ä¸Šä¼ é«˜çº§æ‰«æç»“æœ
    - name: Upload advanced scan results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: advanced-security-results
        path: |
          complexity-results.json
          circular-deps.json
          deps-summary.txt

  # å®‰å…¨é€šçŸ¥
  security-notification:
    runs-on: ubuntu-latest
    needs: [security-scan]
    if: always()
    
    steps:
    - name: Download security artifacts
      uses: actions/download-artifact@v4
      with:
        path: security-results
    
    - name: Check for critical vulnerabilities
      run: |
        echo "Checking for critical security issues..."
        
        # æ£€æŸ¥ npm audit ç»“æœ
        if [ -f security-results/audit-results-node-20/audit-results.json ]; then
          CRITICAL_VULNS=$(jq '.vulnerabilities | to_entries | map(select(.value.severity == "critical")) | length' security-results/audit-results-node-20/audit-results.json || echo "0")
          if [ "$CRITICAL_VULNS" -gt 0 ]; then
            echo "ğŸš¨ CRITICAL: $CRITICAL_VULNS critical vulnerabilities found!"
            exit 1
          else
            echo "âœ… No critical vulnerabilities found"
          fi
        fi
    
    - name: Send security notification
      if: failure()
      run: |
        echo "ğŸš¨ Security scan detected critical issues!"
        echo "Please review the security scan results and address any critical vulnerabilities."
        echo "Artifacts are available in the workflow run."


